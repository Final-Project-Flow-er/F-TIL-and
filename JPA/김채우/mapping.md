# Mapping

---

> 객체 지향적인 설계와 관계형 데이터베이스의 테이블 설계를 연결

---
# 1. 핵심 요소
## 1.1 방향 (Direction)
- **단방향:** 한쪽 객체만 다른 객체를 참조
- **양방향:** 양쪽 객체가 서로를 참조
## 1.2. 다중성 (Multiplicity)
- **다대일 (N:1):** 가장 많이 사용
- **일대다 (1:N)**
- **일대일 (1:1)**
- **다대다 (N:M)**
## 1.3. 연관관계의 주인 (Owner)
양방향 매핑에서 **"누가 외래 키(FK)를 관리할 것인가?"** 를 정하는 것
- **주인(Owner):** 외래 키가 있는 곳(`@JoinColumn`이 붙은 쪽). 실제 DB에 값을 저장/수정
- **가짜(Inverse):** 주인이 아닌 쪽(`mappedBy`가 붙은 쪽). 조회만 가능하고 DB 값을 변경할 수 없음
---
# 2. 다대일과 일대다 차이
## 2.1. 다대일(@ManyToOne)
기준 객체: N(많은 쪽)
연관관계의 주인: 본인(N)
- 외래 키를 직접 관리
  단방향 매핑 시
- 가장 깔끔하고 성능 좋음
  외래 키 위치
- 본인 테이블에 존재
## 2.2. 일대다(@OneToMany)
기준 객체: 1(하나인 쪽)
연관관계의 주인: 상대방(N)
- 양방향 시 본인은 조회만 가능
  단방향 매핑 시
- 비추천
- 불필요한 update 쿼리 발생
  외래 키 위치
- 다수 테이블에 존재
---
# 3. @ManyToOne(fetch=FetchType.LAZY)
JPA 성능 최적화의 기본이자 필수 설정
## 3.1. 동작 원리
DB에서 데이터를 가져오는 시점이 다름
### 3.1.1. FetchType.EAGER
기본값이며 즉시 로딩
매핑되어 있는 테이블의 값까지 추가 쿼리를 던져 한 번에 가져옴
문제점
- 굳이 필요 없는 정보까지 조인해 가져옴
### 3.1.2. FetchType.LAZY
JPA는 매핑되어 있는 값까지 가져오지 않고 가짜 객체(Proxy)를 넣어둠
나중에 매핑된 정보를 사용하는 순간 DB에 쿼리를 날려 데이터를 가져옴
## 3.2. 왜 LAZY를 써야 하나
N+1이라는 성능 이슈
Member가 100명이고 `EAGER`로 설정되어 있을 때
- `findAll()`로 회원 100명 조회 - 쿼리 1개
- JPA는 100명의 정보를 채워 넣음 - 쿼리 100개
  LAZY를 사용하면 필요할 때만 가져오기 때문에 성능 이슈 x
---
# 4. N+1 문제
1번의 쿼리로 N개의 데이터를 가져왔는데 그 N개의 연관된 데이터를 가져오기 위해 N번의 추가 쿼리가 나가는 현상
## 4.1. 발생 원인
JPA가 연관된 객체를 어떻게 가져올지 몰라 메인 객체만 가져온 뒤 필요할 때마다 하나씩 DB에 조회하기 때문
즉시 로딩이든 지연 로딩이든 시점의 문제이지 처음부터 데이터를 가져오지 않으면 반드시 발생
### 4.1.1. 즉시 로딩일 때
`findAll()`을 부르는 순간 JPA가 N번 추가로 조회
### 4.1.2. 지연 로딩일 때
루프를 돌면서 매핑된 데이터가 필요할 때 N번 조회
## 4.2. 해결 방법
### 4.2.1. 페치 조인(Fetch Join)
가장 강력한 해결책
JPQL을 짤 때 `join fetch`를 사용해 처음부터 다 가져오게 하는 것
실무에서는 JPQL보다 [[QueryDSL]]을 사용
```java
// 일반 조인이 아니라 'fetch' 조인 사용
@Query("select s from Student s join fetch s.teacher")
List<Student> findAllWithTeacher();
```
### 4.2.2. @EntityGraph
편리한 방법
어노테이션으로 해결
```java
@EntityGraph(attributePaths = {"teacher"})
@Query("select s from Student s")
List<Student> findAll();
```
### 4.2.3. BatchSize
차선책으로 IN절을 활용
한 개씩 10번 묻지 말고 10개씩 물어보라고 설정하는 것
`spring.jpa.properties.hibernate.default_batch_fetch_size: 100`


---
# 내가 생각한 한 줄 정의
>테이블끼리의 연결을 객체끼리의 연결로 이어주는 것
