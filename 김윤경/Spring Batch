# Spring Batch

## Spring Batch란?

- 대량의 데이터를 일괄 처리(Batch Processing)하기 위한 경량 프레임워크
- 특정 시간에 많은 데이터를 효율적으로 처리하는 것이 목적
- 실시간 서비스 대비 개발 부담이 적다는 인식이 있으나, 대량 데이터 처리 시 성능 최적화 필수

## Spring Batch 구성 요소

- Job: “하루 정산 생성”, “월별 정산 마감” 같은 배치 작업 하나
- Step: Job 안의 실행 단계
- Step은 Chunk 방식 (대용량 처리), 또는 Tasklet 방식 (단순 작업)

## Chunk 처리 핵심 3요소
- Reader  →  Processor  →  Writer

- ItemReader : 데이터를 읽는 역할
- ex) DB 주문 데이터 조회, CSV/Excel 파일 읽기, API 응답 읽기
- ItemProcessor : 데이터를 가공/변환/검증
 - 주문 → 정산 DTO 변환, 수수료 계산, 유효하지 않은 데이터 필터링
- ItemWriter : 데이터를 저장/출력
 - DB insert/update, 정산 결과 파일 생성, 메시지 발행


## Chunk 처리 = N개씩 끊어서 읽고-가공하고-저장
- spring Batch의 대표 처리 방식이 Chunk-oriented processing.
- 흐름 : Reader: DB/CSV/API에서 데이터 읽기
 - Processor: 정산 금액 계산, 상태 변경, 유효성 체크
 - Writer: DB에 저장
- 예: 1,000건 단위(Chunk size=1000) 로 반복
- 사용 이유 : 트랜잭션을 Chunk 단위로 걸 수 있음 
- 10만 건 중 3만 건에서 오류가 나도 앞의 2.9만 건은 이미 커밋되어 안전, 실패 지점부터 재시작 가능
- 메모리 폭발 방지
- 10만 건을 한 번에 메모리에 다 올리는 사고 방지

- 배치 insert = “DB에 한 번에 묶어서 넣기”
- Writer가 DB에 저장할 때 10만 건을 insert 10만 번 호출하지 않고 1,000건씩 모아서 batch insert로 DB round-trip을 줄임
- 기대 효과 : DB 호출 횟수 ↓ → 처리시간 크게 단축, 네트워크/커넥션 부담 ↓

Spring Batch + JPA/Hibernate를 쓴다면 보통: JdbcBatchItemWriter (가장 직관적이고 빠른 편)
- 또는 JPA 사용 시 hibernate.jdbc.batch_size 같은 설정 + flush/clear 전략

- 재시도(Retry)
- 예: 일시적인 DB Deadlock, 네트워크 오류, 외부 API 일시 장애
- “3번까지 재시도, 그래도 실패하면 fail 처리” 같은 정책

- Skip (일부 건만 건너뛰기)
- 10만 건 중 일부 레코드가 데이터 오류
- “오류 난 레코드만 스킵하고 전체 배치는 계속 진행, 스킵 목록 별도 저장”

- 실패 복구 / 재시작(Restart)

- Spring Batch의 큰 장점: Job/Step 실행 상태를 메타 테이블에 저장해서 장애 후에도 중간부터 재시작 가능
